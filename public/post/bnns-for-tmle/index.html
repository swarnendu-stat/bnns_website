<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="Introduction This document demonstrates how to use the bnns package with TMLE for causal inference. TMLE combines machine learning-based flexible models with statistical principles to produce unbiased and efficient estimators of causal effects, such as the Average Treatment Effect (ATE). The example also highlights how the flexibility of Bayesian Neural Networks (BNNs) can improve TMLE results when handling complex data-generating mechanisms. This tutorial borrows from this tmle tutorial.\nSimulating Data We simulate data where the treatment assignment and outcome are influenced by multiple covariates, and the true ATE is known.\n">
<title>Using bnns for TMLE</title>

<link rel='canonical' href='/post/bnns-for-tmle/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="Using bnns for TMLE">
<meta property='og:description' content="Introduction This document demonstrates how to use the bnns package with TMLE for causal inference. TMLE combines machine learning-based flexible models with statistical principles to produce unbiased and efficient estimators of causal effects, such as the Average Treatment Effect (ATE). The example also highlights how the flexibility of Bayesian Neural Networks (BNNs) can improve TMLE results when handling complex data-generating mechanisms. This tutorial borrows from this tmle tutorial.\nSimulating Data We simulate data where the treatment assignment and outcome are influenced by multiple covariates, and the true ATE is known.\n">
<meta property='og:url' content='/post/bnns-for-tmle/'>
<meta property='og:site_name' content=''>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='bnns' /><meta property='article:tag' content='neural network' /><meta property='article:tag' content='Bayesian' /><meta property='article:tag' content='tmle' /><meta property='article:published_time' content='2025-01-17T23:24:25&#43;05:30'/><meta property='article:modified_time' content='2025-01-17T23:24:25&#43;05:30'/><meta property='og:image' content='https://x.com/SwarnenduStat/photo' />
<meta name="twitter:site" content="@https://x.com/SwarnenduStat">
    <meta name="twitter:creator" content="@https://x.com/SwarnenduStat"><meta name="twitter:title" content="Using bnns for TMLE">
<meta name="twitter:description" content="Introduction This document demonstrates how to use the bnns package with TMLE for causal inference. TMLE combines machine learning-based flexible models with statistical principles to produce unbiased and efficient estimators of causal effects, such as the Average Treatment Effect (ATE). The example also highlights how the flexibility of Bayesian Neural Networks (BNNs) can improve TMLE results when handling complex data-generating mechanisms. This tutorial borrows from this tmle tutorial.\nSimulating Data We simulate data where the treatment assignment and outcome are influenced by multiple covariates, and the true ATE is known.\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://x.com/SwarnenduStat/photo' />
    <link rel="shortcut icon" href="/static/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_a76b8da90d73b17e.jpg" width="300"
                            height="293" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üå±</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/"></a></h1>
            <h2 class="site-description">Biostat, Bayes &amp; Blogdown  
‚ú®Statistically Speaking
üìç India
</h2>
        </div>
    </header><ol class="menu" id="main-menu">
        
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    

            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/r/" >
                R
            </a>
        
            <a href="/categories/bnns/" >
                Bnns
            </a>
        
            <a href="/categories/neural-network/" >
                Neural Network
            </a>
        
            <a href="/categories/bayesian/" >
                Bayesian
            </a>
        
            <a href="/categories/tmle/" >
                Tmle
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/post/bnns-for-tmle/">Using bnns for TMLE</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jan 17, 2025</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    5 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="introduction"><a href="#introduction" class="header-anchor"></a>Introduction
</h2><p>This document demonstrates how to use the <a class="link" href="https://cran.r-project.org/package=bnns"  target="_blank" rel="noopener"
    >bnns</a> package with <strong>TMLE</strong> for causal inference. TMLE combines machine learning-based flexible models with statistical principles to produce unbiased and efficient estimators of causal effects, such as the <strong>Average Treatment Effect (ATE)</strong>. The example also highlights how the flexibility of Bayesian Neural Networks (BNNs) can improve TMLE results when handling complex data-generating mechanisms. This tutorial borrows from this <a class="link" href="https://www.khstats.com/blog/tmle/tutorial"  target="_blank" rel="noopener"
    >tmle tutorial</a>.</p>
<hr>
<h2 id="simulating-data"><a href="#simulating-data" class="header-anchor"></a>Simulating Data
</h2><p>We simulate data where the treatment assignment and outcome are influenced by multiple covariates, and the true ATE is known.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(bnns)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Set a random seed for reproducibility</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">123</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Simulate data</span>
</span></span><span style="display:flex;"><span>n <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1000</span>  <span style="color:#75715e"># Number of samples</span>
</span></span><span style="display:flex;"><span>X1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rnorm</span>(n)
</span></span><span style="display:flex;"><span>X2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rnorm</span>(n)
</span></span><span style="display:flex;"><span>U <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rbinom</span>(n, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0.5</span>)  <span style="color:#75715e"># Unmeasured confounder</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Treatment mechanism (biased by U)</span>
</span></span><span style="display:flex;"><span>ps <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">plogis</span>(<span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> X1 <span style="color:#f92672">-</span> <span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> X2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">0.8</span> <span style="color:#f92672">*</span> U)
</span></span><span style="display:flex;"><span>A <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rbinom</span>(n, <span style="color:#ae81ff">1</span>, ps)  <span style="color:#75715e"># Treatment assignment</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Outcome mechanism (non-linear and confounded by U)</span>
</span></span><span style="display:flex;"><span>Y_prob <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">plogis</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> X1^2 <span style="color:#f92672">-</span> <span style="color:#ae81ff">1.5</span> <span style="color:#f92672">*</span> X2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1.2</span> <span style="color:#f92672">*</span> A <span style="color:#f92672">+</span> <span style="color:#ae81ff">1.5</span> <span style="color:#f92672">*</span> U)
</span></span><span style="display:flex;"><span>Y <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rbinom</span>(n, <span style="color:#ae81ff">1</span>, Y_prob)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Combine into a dataset</span>
</span></span><span style="display:flex;"><span>sim_data <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">data.frame</span>(Y, A, X1, X2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># True ATE for comparison</span>
</span></span><span style="display:flex;"><span>true_ate <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">mean</span>(<span style="color:#a6e22e">plogis</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> X1^2 <span style="color:#f92672">-</span> <span style="color:#ae81ff">1.5</span> <span style="color:#f92672">*</span> X2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1.2</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1.5</span> <span style="color:#f92672">*</span> U)) <span style="color:#f92672">-</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mean</span>(<span style="color:#a6e22e">plogis</span>(<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> X1^2 <span style="color:#f92672">-</span> <span style="color:#ae81ff">1.5</span> <span style="color:#f92672">*</span> X2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1.2</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1.5</span> <span style="color:#f92672">*</span> U))
</span></span><span style="display:flex;"><span>true_ate
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; [1] 0.07431068</span>
</span></span></code></pre></div><hr>
<h2 id="applying-tmle-with-bnns"><a href="#applying-tmle-with-bnns" class="header-anchor"></a>Applying TMLE with <code>bnns</code>
</h2><h3 id="step-1-install-and-load-required-packages"><a href="#step-1-install-and-load-required-packages" class="header-anchor"></a>Step 1: Install and Load Required Packages
</h3><p>Ensure that the <strong><code>bnns</code></strong> and <strong><code>tmle</code></strong> packages are installed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#75715e"># Install ggplot2 and bnns from CRAN</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># install.packages(&#34;ggplot2&#34;)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># install.packages(&#34;bnns&#34;)</span>
</span></span></code></pre></div><h3 id="step-2-tmle-implementation"><a href="#step-2-tmle-implementation" class="header-anchor"></a>Step 2: TMLE Implementation
</h3><p>We use <code>tmle</code> to estimate the ATE. Both the treatment mechanism (<code>g</code>) and the outcome mechanism (<code>Q</code>) are modeled using Bayesian Neural Networks via the <code>bnns</code> package.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#75715e">### Step 1: Estimate Q</span>
</span></span><span style="display:flex;"><span>Q <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">bnns</span>(Y <span style="color:#f92672">~</span> <span style="color:#ae81ff">-1</span> <span style="color:#f92672">+</span> ., data <span style="color:#f92672">=</span> sim_data, L <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, nodes <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>), act_fn <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>), out_act_fn <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Q_A <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">predict</span>(Q) <span style="color:#75715e"># obtain predictions for everyone using the treatment they actually received</span>
</span></span><span style="display:flex;"><span>sim_data_1 <span style="color:#f92672">&lt;-</span> sim_data <span style="color:#f92672">|&gt;</span> <span style="color:#a6e22e">transform</span>(A <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>)  <span style="color:#75715e"># data set where everyone received treatment</span>
</span></span><span style="display:flex;"><span>Q_1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">predict</span>(Q, newdata <span style="color:#f92672">=</span> sim_data_1) <span style="color:#75715e"># predict on that everyone-exposed data set</span>
</span></span><span style="display:flex;"><span>sim_data_0 <span style="color:#f92672">&lt;-</span> sim_data <span style="color:#f92672">|&gt;</span> <span style="color:#a6e22e">transform</span>(A <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>) <span style="color:#75715e"># data set where no one received treatment</span>
</span></span><span style="display:flex;"><span>Q_0 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">predict</span>(Q, newdata <span style="color:#f92672">=</span> sim_data_0)
</span></span><span style="display:flex;"><span>dat_tmle <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lapply</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#a6e22e">dim</span>(Q_A)[2], <span style="color:#66d9ef">function</span>(i) <span style="color:#a6e22e">data.frame</span>(Y <span style="color:#f92672">=</span> sim_data<span style="color:#f92672">$</span>Y, A <span style="color:#f92672">=</span> sim_data<span style="color:#f92672">$</span>A, Q_A <span style="color:#f92672">=</span> Q_A[,i], Q_0 <span style="color:#f92672">=</span> Q_0[,i], Q_1 <span style="color:#f92672">=</span> Q_1[,i]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### Step 2: Estimate g and compute H(A,W)</span>
</span></span><span style="display:flex;"><span>g <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">bnns</span>(A <span style="color:#f92672">~</span> <span style="color:#ae81ff">-1</span> <span style="color:#f92672">+</span> . <span style="color:#f92672">-</span> Y, data <span style="color:#f92672">=</span> sim_data, L <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, nodes <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>), act_fn <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>), out_act_fn <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>g_w <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">predict</span>(g) <span style="color:#75715e"># Pr(A=1|W)</span>
</span></span><span style="display:flex;"><span>H_1 <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>g_w
</span></span><span style="display:flex;"><span>H_0 <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">-1</span><span style="color:#f92672">/</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span>g_w) <span style="color:#75715e"># Pr(A=0|W) is 1-Pr(A=1|W)</span>
</span></span><span style="display:flex;"><span>dat_tmle <span style="color:#f92672">&lt;-</span> <span style="color:#75715e"># add clever covariate data to dat_tmle</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">lapply</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#a6e22e">dim</span>(Q_A)[2], <span style="color:#66d9ef">function</span>(i) dat_tmle[[i]] <span style="color:#f92672">|&gt;</span>
</span></span><span style="display:flex;"><span>           <span style="color:#a6e22e">cbind</span>(
</span></span><span style="display:flex;"><span>             H_1 <span style="color:#f92672">=</span> H_1[,i],
</span></span><span style="display:flex;"><span>             H_0 <span style="color:#f92672">=</span> H_0[,i]) <span style="color:#f92672">|&gt;</span>
</span></span><span style="display:flex;"><span>           <span style="color:#a6e22e">transform</span>(H_A <span style="color:#f92672">=</span> <span style="color:#a6e22e">ifelse</span>(A <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>, H_1, <span style="color:#75715e"># if A is 1 (treated), assign H_1</span>
</span></span><span style="display:flex;"><span>                               H_0))  <span style="color:#75715e"># if A is 0 (not treated), assign H_0</span>
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### Step 3: Estimate fluctuation parameter</span>
</span></span><span style="display:flex;"><span>tmle_ate_list <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lapply</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#a6e22e">dim</span>(Q_A)[2], <span style="color:#66d9ef">function</span>(i){
</span></span><span style="display:flex;"><span>  glm_fit <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">glm</span>(Y <span style="color:#f92672">~</span> <span style="color:#ae81ff">-1</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">offset</span>(<span style="color:#a6e22e">qlogis</span>(Q_A)) <span style="color:#f92672">+</span> H_A, data<span style="color:#f92672">=</span>dat_tmle[[i]], family<span style="color:#f92672">=</span>binomial) <span style="color:#75715e"># fixed intercept logistic regression</span>
</span></span><span style="display:flex;"><span>  eps <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">coef</span>(glm_fit) <span style="color:#75715e"># save the only coefficient, called epsilon in TMLE lit</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">### Step 4: Update Q&#39;s</span>
</span></span><span style="display:flex;"><span>  Q_A_update <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">with</span>(dat_tmle[[i]], <span style="color:#a6e22e">plogis</span>(<span style="color:#a6e22e">qlogis</span>(Q_A) <span style="color:#f92672">+</span> eps<span style="color:#f92672">*</span>H_A)) <span style="color:#75715e"># updated expected outcome given treatment actually received</span>
</span></span><span style="display:flex;"><span>  Q_1_update <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">with</span>(dat_tmle[[i]], <span style="color:#a6e22e">plogis</span>(<span style="color:#a6e22e">qlogis</span>(Q_1) <span style="color:#f92672">+</span> eps<span style="color:#f92672">*</span>H_1)) <span style="color:#75715e"># updated expected outcome for everyone receiving treatment</span>
</span></span><span style="display:flex;"><span>  Q_0_update <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">with</span>(dat_tmle[[i]], <span style="color:#a6e22e">plogis</span>(<span style="color:#a6e22e">qlogis</span>(Q_0) <span style="color:#f92672">+</span> eps<span style="color:#f92672">*</span>H_0)) <span style="color:#75715e"># updated expected outcome for everyone not receiving treatment</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">### Step 5: Compute ATE</span>
</span></span><span style="display:flex;"><span>  tmle_ate <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">mean</span>(Q_1_update <span style="color:#f92672">-</span> Q_0_update) <span style="color:#75715e"># mean diff in updated expected outcome estimates  </span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>(tmle_ate)
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tmle_ate <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">unlist</span>(tmle_ate_list)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">median</span>(tmle_ate)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; [1] 0.08954665</span>
</span></span></code></pre></div><hr>
<h2 id="comparing-tmle-to-traditional-methods"><a href="#comparing-tmle-to-traditional-methods" class="header-anchor"></a>Comparing TMLE to Traditional Methods
</h2><p>To highlight the benefits of TMLE, compare it to other methods such as:</p>
<ol>
<li><strong>IPTW (Inverse Probability of Treatment Weighting)</strong></li>
<li><strong>Naive Comparison (Unadjusted Difference in Means)</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(tmle)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; Loading required package: glmnet</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; Loading required package: Matrix</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; Loaded glmnet 4.1-8</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; Loading required package: SuperLearner</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; Loading required package: nnls</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; Loading required package: gam</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; Loading required package: splines</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; Loading required package: foreach</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; Loaded gam 1.22-5</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; Super Learner</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; Version: 2.0-29</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; Package created on 2024-02-06</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; Welcome to the tmle package, version 2.0.1.1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; Use tmleNews() to see details on changes and bug fixes</span>
</span></span><span style="display:flex;"><span>freq_tmle <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tmle</span>(
</span></span><span style="display:flex;"><span>  Y <span style="color:#f92672">=</span> sim_data<span style="color:#f92672">$</span>Y, A <span style="color:#f92672">=</span> sim_data<span style="color:#f92672">$</span>A, 
</span></span><span style="display:flex;"><span>  W <span style="color:#f92672">=</span> sim_data[, <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;X1&#34;</span>, <span style="color:#e6db74">&#34;X2&#34;</span>)], 
</span></span><span style="display:flex;"><span>  Q.SL.library <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;SL.glm&#34;</span>, <span style="color:#e6db74">&#34;SL.ranger&#34;</span>),
</span></span><span style="display:flex;"><span>  g.SL.library <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;SL.glm&#34;</span>, <span style="color:#e6db74">&#34;SL.ranger&#34;</span>)
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; Loading required namespace: ranger</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Results</span>
</span></span><span style="display:flex;"><span>freq_tmle_ate <span style="color:#f92672">&lt;-</span> freq_tmle<span style="color:#f92672">$</span>estimates<span style="color:#f92672">$</span>ATE<span style="color:#f92672">$</span>psi
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Naive Comparison</span>
</span></span><span style="display:flex;"><span>naive_ate <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">mean</span>(sim_data<span style="color:#f92672">$</span>Y[sim_data<span style="color:#f92672">$</span>A <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>]) <span style="color:#f92672">-</span> <span style="color:#a6e22e">mean</span>(sim_data<span style="color:#f92672">$</span>Y[sim_data<span style="color:#f92672">$</span>A <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Summary of Results</span>
</span></span><span style="display:flex;"><span>results <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">data.frame</span>(
</span></span><span style="display:flex;"><span>  Method <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;True ATE&#34;</span>, <span style="color:#e6db74">&#34;BNN_TMLE&#34;</span>, <span style="color:#e6db74">&#34;Freq_TMLE&#34;</span>, <span style="color:#e6db74">&#34;Naive&#34;</span>),
</span></span><span style="display:flex;"><span>  Estimate <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(true_ate, <span style="color:#a6e22e">median</span>(tmle_ate), freq_tmle_ate, naive_ate),
</span></span><span style="display:flex;"><span>  CI_low <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(true_ate, <span style="color:#a6e22e">quantile</span>(tmle_ate, probs <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0.025</span>)), freq_tmle<span style="color:#f92672">$</span>estimates<span style="color:#f92672">$</span>ATE<span style="color:#f92672">$</span>CI[1], naive_ate),
</span></span><span style="display:flex;"><span>  CI_high <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(true_ate, <span style="color:#a6e22e">quantile</span>(tmle_ate, probs <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0.975</span>)), freq_tmle<span style="color:#f92672">$</span>estimates<span style="color:#f92672">$</span>ATE<span style="color:#f92672">$</span>CI[2], naive_ate)
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>results
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt;      Method   Estimate     CI_low    CI_high</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; 1  True ATE 0.07431068 0.07431068 0.07431068</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; 2  BNN_TMLE 0.08954665 0.08369176 0.09577273</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; 3 Freq_TMLE 0.09309979 0.05910546 0.12709413</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#&gt; 4     Naive 0.12824940 0.12824940 0.12824940</span>
</span></span></code></pre></div><hr>
<h2 id="visualizing-results"><a href="#visualizing-results" class="header-anchor"></a>Visualizing Results
</h2><p>Plot the estimates from different methods to compare their performance.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(ggplot2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ggplot</span>(results, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> forcats<span style="color:#f92672">::</span><span style="color:#a6e22e">fct_reorder</span>(Method, Estimate), y <span style="color:#f92672">=</span> Estimate, fill <span style="color:#f92672">=</span> Method)) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">geom_bar</span>(stat <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;identity&#34;</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;black&#34;</span>) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">geom_hline</span>(yintercept <span style="color:#f92672">=</span> true_ate, linetype <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;dashed&#34;</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;red&#34;</span>) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">geom_errorbar</span>(mapping <span style="color:#f92672">=</span> <span style="color:#a6e22e">aes</span>(ymin <span style="color:#f92672">=</span> CI_low, ymax <span style="color:#f92672">=</span> CI_high)) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">labs</span>(
</span></span><span style="display:flex;"><span>    title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Comparison of ATE Estimates&#34;</span>,
</span></span><span style="display:flex;"><span>    y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ATE Estimate&#34;</span>,
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Method&#34;</span>
</span></span><span style="display:flex;"><span>  ) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">theme_minimal</span>() <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">theme</span>(legend.position <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;none&#34;</span>)
</span></span></code></pre></div><img src="/post/bnns-for-tmle/index_files/figure-html/visualization-1.png" width="672" />
<hr>
<h2 id="summary"><a href="#summary" class="header-anchor"></a>Summary
</h2><p>This tutorial demonstrates how to use the <a class="link" href="https://swarnendu-stat.github.io/bnns/"  target="_blank" rel="noopener"
    >bnns</a> package for TMLE to estimate the Average Treatment Effect (ATE). By leveraging the flexibility of Bayesian Neural Networks, TMLE can handle complex data structures and improve accuracy compared to traditional methods. Use this workflow for applications in clinical trials, epidemiology, and other domains requiring robust causal inference.</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/bnns/">Bnns</a>
        
            <a href="/tags/neural-network/">Neural Network</a>
        
            <a href="/tags/bayesian/">Bayesian</a>
        
            <a href="/tags/tmle/">Tmle</a>
        
    </section>


    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
	const mainArticleElement = document.querySelector(".main-article");
        renderMathInElement(mainArticleElement, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>

    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 
    </section>
    
    <section class="powerby">
        
            <a href="https://www.r-bloggers.com/" target="_blank">R Bloggers</a> <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
